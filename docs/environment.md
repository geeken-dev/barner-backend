開発環境
================================================================
## ローカル開発環境
ローカルでは主に2つのテスト環境を想定する。

- DBなど必要なものをすべてコンテナで動かし、docker-composeを使用して接続する
- gcloud emulatorsを使用しクラウド環境へのテスト
  - こちらでもdocker-composeを使うことにはなる想定
### gcloud emulatorsを使わない検証環境
この環境はカジュアルに立ち上げられるので通常の開発に適している。  
以下のような手順を想定する。  

- `devcontainer up`などでコンテナ群をローカルに立ち上げる
  - postgresqlなど必要なものが立ち上がる（今後redisとか使うかも？）
- point-serverを`go run`などで起動する
- postmanやcurlなどで動作確認したいAPIを叩く

### gcloud emulatorsを使った検証環境
こちらは本番にかなり近い状態で検証できる。  
インフラに関わるコードを操作した場合などの動作確認に適している。  

### その他
環境とは言えないが、`act`でGitHub Actionsのローカルタスクランナーを動かし、CI/CDのテストを必要に応じて行う。  

## クラウド環境
ひとまずdev環境が最低限必要で、段階的にそれ以外の環境も追加で必要となるはず。
以下にそれぞれの環境の用途・目的/CDの設定を示す。

- dev環境
  - featureブランチを反映して自動でデプロイ
  - 開発が活発すぎてデプロイが頻繁に衝突するようになったらやりかた変えるかも。
  - 通常の開発の動作確認に使う
- staging環境
  - mainブランチからリリースタグを作成すると自動でデプロイ
  - リリース直前の最終動作確認に使う
  - production環境と一緒に必要になる想定
- production環境
  - staging環境に上がった状態から手動でトリガーしてデプロイ
  - プロダクトが実際に運用される
- test環境
  - featureブランチから手動でトリガーしデプロイ
  - やや長期的に開発が進んでいてdev環境とは独立させたい場合
  - 2人以上のユーザが同時に使いたい場合は譲り合うか、複数建てられる仕組みが必要になる（要検討）

### メモ
メンバーが増えるなどして開発が活発になってくるとdev環境のデプロイが追いつかなくなることがありうる。    
その場合、タイミングをメンバー間で調整するか、devへのデプロイをmainブランチのマージによってトリガーされるようにした上で、前述の
test環境を増発する、あるいはdev環境が複数立つようにしつつ、古いものから落としていくような設計などいくつか運用が考えられる。  
いきなりは必要ないのでdev環境のみfeatureブランチでトリガーされる設定で様子を見つつ、都度議論して対応する。  

## 環境変数について
以下の定義が現状必要。必要に応じて追記する。

- SYSTEM_ENV
  - dev/stg/prod/test ...
- LOG_LEVEL
  - debug/info ...
- PORT
  - 8080 ...
- POSTGRES_HOST
  - localhost ...
- POSTGRES_PORT
  - 5432 ...
- POSTGRES_DB_NAME
  - point-core ...
- POSTGRES_USER
  - postgres ...
- POSTGRES_PASSWORD
  - password ...

### 切替方法
- ローカル
  - ターミナルで環境変数をexportすればよい。起動用シェルスクリプトを置くのが現実的か。
- クラウド
  - `SYSTEM_ENV=prod gcloud deploy` のようにデプロイするイメージ
  - 秘匿する必要がない環境変数
    - terraform(kustomize?)に書いておく
    - 環境によって変わるのでSYSTEM_ENVの内容に応じて分岐させるコードにする
  - passwordなどについて
    - Google Cloud Secret Managerで設定を流し込む。
    - シークレットはKEK(Cloud Key Management)でセキュアに管理できる。

